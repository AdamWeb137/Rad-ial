class Radial{static containers=[];static scopes={};static create_scope(e,t){let s={...{"+":(...e)=>{let t=0;for(let s of e)t+=s;return t},"*":(...e)=>{let t=1;for(let s of e)t*=s;return t},"-":(...e)=>{let t=e[0]??0;e=e.slice(1);for(let s of e)t-=s;return t},"/":(...e)=>{let t=e[0]??0;e=e.slice(1);for(let s of e)t/=s;return t},concat:(...e)=>{let t="";for(let s of e)t+=s;return t},obj:(e,...t)=>{for(let s=0;s<t.length;s++)e=e[t[s]];return e},get_target:(e,t,...s)=>{t(e.target,...s)},range:(e,t)=>{const s=new Array(t-e);for(let t=0;t<s.length;t++)s[t]=e+t;return s},"%":(e,t)=>e%t,ternary:(e,t,s)=>e?t:s,local:{index:-1}}};Radial.scopes[e]=s,t(Radial.scopes[e])}static GetCurrent=class{constructor(e,t){this.scope=e,this.var_name=t}get(){return this.scope[this.var_name]}};constructor(e,t,s={opener:"{{",closer:"}}"},r={opener:"((",closer:"))"},n={opener:"[[",closer:"]]"}){this.container=e,this.var_markers=s,this.func_markers=r,this.bind_markers=n,this.scope=t,this.expressions={},this.unique_expression_id=-1,this.unique_local_id=-1,this.local_scopes=new Set,Radial.containers.push(this)}interpret_object_string(e,t=[],s={}){const r=(e=e.trim()).split(".");if(0==r.length)return;let n=r[0],i=this.scope;t.includes(n)&&(i=i.local),n in s&&(i=s);for(let e=0;e<r.length-1;e++)i=i[r[e]];return{scope:i,var_name:r[r.length-1]}}get_var_expression(e,t=[],s={}){e=e.trim();this.scope;let r=this.interpret_object_string(e,t,s);return new Radial.GetCurrent(r.scope,r.var_name)}get_func_expression(e,t=[],s={}){const r=(e=e.trim()).match(/('[^']+'|[^,]+)/g),n=e=>{if((e=e.trim())in s)return s[e];if(0==e.length)return;if("false"==e)return!1;if("true"==e)return!0;if("undefined"==e||"null"==e)return;if(e.length>=2&&("'"==e[0]&&"'"==e[e.length-1]||'"'==e[0]&&'"'==e[e.length-1]))return e.slice(1,e.length-1);if(!isNaN(+e))return+e;if(e.length>=2&&"{"==e[0]&&"}"==e[e.length-1])try{return JSON.parse(e)}catch(r){let n=this.interpret_object_string(e,t,s);return new Radial.GetCurrent(n.scope,n.var_name)}let r=this.interpret_object_string(e,t,s);return new Radial.GetCurrent(r.scope,r.var_name)};return r.map((e=>n(e)))}on_removed(e){for(let t of e)for(let e of this.loop_expressions())(e.element==t||t.contains(e.element))&&(e=void 0)}create_new_expression(e,t,s){let r;if(this.unique_expression_id++,this.expressions[this.unique_expression_id]={element:e,found_in:t},null!=s)switch(this.expressions[this.unique_expression_id].attribute_name=s,s){case"loop":this.unique_local_id++,this.local_scopes.add(this.unique_local_id),e.setAttribute("rad-id",this.unique_local_id),this.scope.local[this.unique_local_id]=[],r=this.get_loop_func(e.getAttribute(s),this.unique_local_id,e);break;default:r=this.get_expression_func(e.getAttribute(s))}else r=this.get_expression_func(e.innerText);this.expressions[this.unique_expression_id].func=r}get_inner_text(e){return[].reduce.call(e.childNodes,(function(e,t){return e+(3===t.nodeType?t.textContent:"")}),"")}string_includes_expression(e,t){const s=e.indexOf(t.opener),r=e.indexOf(t.closer);return s>-1&&r>s}search_for_expressions(e){for(let t=0;t<e.attributes.length;t++){let s=e.attributes[t];s.name.length>=4&&s.name.slice(0,2)==this.bind_markers.opener&&s.name.slice(s.name.length-2,s.name.length)==this.bind_markers.closer&&this.handle_event_binds(e,s.name),(this.string_includes_expression(s.value,this.var_markers)||this.string_includes_expression(s.value,this.func_markers))&&this.create_new_expression(e,"attribute",s.name)}if(0==e.children.length)(this.string_includes_expression(e.innerText,this.var_markers)||this.string_includes_expression(e.innerText,this.func_markers))&&this.create_new_expression(e,"text");else{if(this.string_includes_expression(this.get_inner_text(e),this.var_markers))throw Error("inside expressions only allowed within elements with NO children");if(this.string_includes_expression(this.get_inner_text(e),this.func_markers))throw Error("inside expressions only allowed within elements with NO children")}}get_expression_func(e,t=[]){const s=[];let r="open",n="var",i="var_markers",l="",o=0,a="",c="";const h=()=>{s.push(l),l=""},u=e=>{switch(o){case 0:'"'!=e&&"'"!=e||(o=1,a=e);break;case 1:"\\"!=c&&e==a&&(o=0)}c=e},_=e=>{switch(n){case"var":return()=>this.get_var_expression(e,t).get();case"func":return()=>{const s=this.get_func_expression(e,t),r=s[0].get(),n=s.slice(1);for(let e=0;e<n.length;e++)n[e]instanceof Radial.GetCurrent&&(n[e]=n[e].get());let i="";return"function"==typeof r&&(i=r(...n)),i}}};for(let t=0;t<e.length;t++)switch(r){case"open":e.slice(t,t+2)==this.var_markers.opener?(r="close",n="var",i="var_markers",h(),t+=1):e.slice(t,t+2)==this.func_markers.opener?(r="close",n="func",i="func_markers",h(),t+=1,o=0):l+=e[t];break;case"close":e.slice(t,t+2)==this[i].closer&&0==o?(r="open",o=0,s.push(_(l)),t+=1,l=""):("\\"==e[t]?"\\"==c&&(l+=e[t]):l+=e[t],u(e[t]))}h();return function(e,t){let r="";for(let e of s)r+="function"==typeof e?e():e;return r}}get_loop_func(e,t,s){if("TEMPLATE"!==s.nodeName)throw Error("radial loops only allowed on template elements");const r=s.getAttribute("loop-var");if(null==r)throw Error("radial loops require a loop-var attribute with desired loop variable name");if(0==r.length)throw Error("loop-var attribute must be filled");const n=(()=>{if(null==s.content.firstElementChild)throw Error("loop template element must include child element");let e=s.content.firstElementChild.innerHTML,t=s.content.firstElementChild.nodeName.toLowerCase(),r=[];for(let e=0;e<s.content.firstElementChild.attributes.length;e++){let t=s.content.firstElementChild.attributes[e];t.value?r.push(`${t.name}="${t.value}"`):r.push(t.name)}return{inner:e,attributes:r.join(" "),tag:t}})(),i=this.get_expression_func(n.inner,[r,"index"]),l=this.get_expression_func(n.attributes,[r,"index"]);let o=()=>{this.scope.local[t]=[]},a=e.slice(2,e.length-2);return e.slice(0,2)==this.var_markers.opener&&e.slice(e.length-2,e.length)==this.var_markers.closer&&(o=()=>{this.scope.local[t]=this.get_var_expression(a,[r,"index"]).get()}),e.slice(0,2)==this.func_markers.opener&&e.slice(e.length-2,e.length)==this.func_markers.closer&&(o=()=>{const e=this.get_func_expression(a,[r,"index"]),s=e[0].get(),n=e.slice(1);for(let e=0;e<n.length;e++)n[e]instanceof Radial.GetCurrent&&(n[e]=n[e].get());let i;"function"==typeof s&&(i=s(...n)),this.scope.local[t]=i}),()=>{o();let e=document.querySelectorAll(`.radial_loop_${r}`);for(let t of e)t.remove();const a=(e,t)=>{let s="",r="",n=!0;for(let i=0;i<e.length;i++)e[i]==t&&n?n=!1:(n&&(s+=e[i]),n||(r+=e[i]));return{left:s,right:r}};let c=[];for(let e=0;e<this.scope.local[t].length;e++){this.scope.local[r]=this.scope.local[t][e],this.scope.local.index=e;let s=document.createElement(n.tag),o=l().match(/(?:[^\s"]+|"[^"]*")+/g);null==o&&(o=[]);for(let t of o){let n=a(t,"=");'"'==n.right[0]&&'"'==n.right[n.right.length-1]&&(n.right=n.right.slice(1,n.right.length-1)),n.left.length>=4&&n.left.slice(0,2)==this.bind_markers.opener&&n.left.slice(n.left.length-2,n.left.length)==this.bind_markers.closer?this.handle_event_binds(s,n.left,[r],{index:e}):s.setAttribute(n.left,n.right)}s.classList.add(`radial_loop_${r}`),s.innerHTML=i(),this.handle_events(s),c.push(s)}s.after(...c)}}handle_var_binds(e){const t={TEXTAREA:"input",INPUT:"input",SELECT:"change"},s={TEXTAREA:e=>e.value,INPUT:e=>e.value,SELECT:e=>e.options[e.selectedIndex].text};if(["TEXTAREA","INPUT","SELECT"].includes(e.nodeName)&&null!=e.getAttribute("bind-var")){let r=e.getAttribute("bind-var");e.value=this.scope[r],e.addEventListener(t[e.nodeName],(()=>{let t=s[e.nodeName](e);this.scope[r]=t,this.run_expressions()}))}}handle_event_binds(e,t,s=[],r={}){t=t.slice(2,t.length-2);const n=this.get_func_expression(t,s,r),i=n[0]instanceof Radial.GetCurrent?n[0].var_name:String(n[0]),l=n[1].get(),o=n.slice(2);e.addEventListener(i,(e=>{const t=o.map((e=>e instanceof Radial.GetCurrent?e.get():e));l(e,...t),this.run_expressions()}))}handle_events(e){this.handle_var_binds(e);for(let t=0;t<e.attributes.length;t++){let s=e.attributes[t];s.name.length>=4&&s.name.slice(0,2)==this.bind_markers.opener&&s.name.slice(s.name.length-2,s.name.length)==this.bind_markers.closer&&this.handle_event_binds(e,s.name)}if(e.children.length>0)for(let t of e.children)this.handle_events(t)}search_for_expressions_recursive(e){if(e instanceof HTMLElement&&(this.search_for_expressions(e),this.handle_var_binds(e),e.children.length>0))for(let t of e.children)this.search_for_expressions_recursive(t)}on_added(e){for(let t of e)this.search_for_expressions_recursive(t)}on_attr(e,t){let s=e.getAttribute(t);(this.string_includes_expression(s,this.var_markers)||this.string_includes_expression(s,this.func_markers))&&this.create_new_expression(e,"attribute",t)}observe(){new MutationObserver(((e,t)=>{for(const t of e)"childList"===t.type&&(this.on_removed(t.removedNodes),this.on_added(t.addedNodes))})).observe(this.container,{attributes:!0,childList:!0,subtree:!0})}observe_attrs(e){new MutationObserver(((t,s)=>{for(const s of t)"attributes"===s.type&&this.on_attr(e,s.attributeName)})).observe(e,{attributes:!0})}*loop_expressions(){let e=0;for(;e<=this.unique_expression_id;)null!=this.expressions[e]&&(yield this.expressions[e]),e++}run_expressions(){for(let e of this.loop_expressions()){let t;switch(e.found_in){case"attribute":t=e.func(),"loop"!=e.attribute_name&&e.element.setAttribute(e.attribute_name,t);break;case"text":t=e.func(),e.element.innerText=t}}}}customElements.define("rad-ial",class extends HTMLElement{constructor(){super()}set_scope(){null!=this.getAttribute("scope")&&(this.radial=new Radial(this,Radial.scopes[this.getAttribute("scope")]),Object.defineProperty(this.radial.scope,"reload",{value:()=>{this.radial.run_expressions()},writable:!1,enumerable:!0,configurable:!0}),window.addEventListener("load",(()=>{this.radial.search_for_expressions_recursive(this),this.radial.run_expressions()})),this.removeAttribute("scope"))}connectedCallback(){this.set_scope()}attributeChangedCallback(e,t,s){this.set_scope()}static get observedAttributes(){return["scope"]}});